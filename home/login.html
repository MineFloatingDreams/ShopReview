<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="UTF-8">
    <title>登录</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <link rel="stylesheet" href="../AmazeUI-2.4.2/assets/css/amazeui.css" />
    <link href="../css/dlstyle.css" rel="stylesheet" type="text/css">
    <script src="../js/jquery.js"></script>
    <style>
        .loginDiv {
            padding-top: 70px;
        }
        
        .myform {
            margin-top: 30px;
        }
    </style>
    <!-- 人脸识别 -->
    <script>
    </script>
    <!-- 登录方式切换 -->
    <script>
        function phoneLogin() {
            $("#loginForm").html(`
			<h3 class="title">登录商城</h3>
                <div class="login-form myform">
                    <form>
                        <div class="user-phone">
                                    <label for="phone"><i class="am-icon-mobile-phone am-icon-md"></i></label>
                                    <input type="tel" name="phone" id="phone" placeholder="请输入手机号">
                                </div>
                        <div class="user-text">
                            <label for="text"><i class="am-icon-lock"></i></label>
                            <input type="text" name="code" id="code" placeholder="请输入验证码">
                        </div>
                    </form>
                </div>

                <div class="login-links">
                    <a href="register.html" class="zcnext am-fr am-btn-default">注册</a>
                    <br/>
                </div>
                <div class="am-cf">
                    <input type="button" id="loginByPhone" name="" value="登 录" class="am-btn am-btn-primary am-btn-sm">
                </div>
                <span onclick="usernameLogin()" id="s1">账号登录</span>
                <span>|</span>
                <span onclick="phoneLogin()" id="s2">手机登录</span>
                <span>|</span>
                <span onclick="faceLogin()" id="s3">人脸登录</span>
                `);
        };

        function uploadImage() {

            let canvas = document.getElementById('canvas');
            let context = canvas.getContext('2d');
            canvas.width = 300;
            canvas.height = 300;
            context.drawImage(video, 0, 0, 300, 300);
            var imgData = canvas.toDataURL();
            console.log(imgData);
            //上传到后台。
            var uploadAjax = $.ajax({
                type: "post",
                //后端需要调用的地址
                url: "127.0.0.1:8080/ShopSystem/loginByFace",
                data: {
                    "imgData": imgData
                },
                contentType: "json/application",
                //设置超时
                timeout: 10000,
                async: true,
                success: function(htmlVal) {
                    alert("登录成功");
                },
                error: function(data) {},
                //调用执行后调用的函数
                complete: function(XMLHttpRequest, textStatus) {
                    if (textStatus == 'timeout') {
                        uploadAjax.abort(); //取消请求
                        //超时提示：请求超时，请重试
                        alert("请求超时，请重试")
                            //请求超时返回首页
                        closeCard();
                    }
                }
            });
        }

        function faceLogin() {
            $("#loginForm").html(`
			<h3 class="title">登录商城</h3>
                
				<video id="video" width="320" height="180" controls></video>
                <button id="capture" onclick="uploadImage()" class="am-btn am-btn-primary am-btn-sm">登录</button>

                <div class="login-links">
                    <a href="register.html" class="zcnext am-fr am-btn-default">注册</a>
                </div>
				<span onclick="usernameLogin()" id="s1">账号登录</span>
                <span>|</span>
                <span onclick="phoneLogin()" id="s2">手机登录</span>
                <span>|</span>
                <span onclick="faceLogin()" id="s3">人脸登录</span>
                `);
            //访问用户媒体设备的兼容方法
            function getUserMedia(constraints, success, error) {
                if (navigator.mediaDevices.getUserMedia) {
                    //最新的标准API
                    navigator.mediaDevices.getUserMedia(constraints).then(success).catch(error);
                } else if (navigator.webkitGetUserMedia) {
                    //webkit核心浏览器
                    navigator.webkitGetUserMedia(constraints, success, error)
                } else if (navigator.mozGetUserMedia) {
                    //firfox浏览器
                    navigator.mozGetUserMedia(constraints, success, error);
                } else if (navigator.getUserMedia) {
                    //旧版API
                    navigator.getUserMedia(constraints, success, error);
                }
            }



            function success(stream) {
                //兼容webkit核心浏览器
                let CompatibleURL = window.URL || window.webkitURL;
                //将视频流设置为video元素的源
                console.log(stream);

                //video.src = CompatibleURL.createObjectURL(stream);
                video.srcObject = stream;
                video.play();
            }

            function error(error) {
                console.log(`访问用户媒体设备失败${error.name}, ${error.message}`);
            }

            if (navigator.mediaDevices.getUserMedia || navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia) {
                //调用用户媒体设备, 访问摄像头
                getUserMedia({
                    video: {
                        width: 480,
                        height: 320
                    }
                }, success, error);
            } else {
                alert('不支持访问用户媒体');
            }
            let video = document.getElementById('video');
            video.controls = false;

            // document.getElementById('capture').addEventListener('click', function() {
            //         context.drawImage(video, 0, 0, 480, 320);
            //     })
            //图片上传到服务器
            //获取Canvas的编码。



            //下面的代码是保存canvas标签里的图片并且将其按一定的规则重命名
            var type = 'png';

            var _fixType = function(type) {
                type = type.toLowerCase().replace(/jpg/i, 'jpeg');
                var r = type.match(/png|jpeg|bmp|gif/)[0];
                return 'image/' + r;
            };

            var saveFile = function(filename) {
                //获取canvas标签里的图片内容
                var imgData = document.getElementById('canvas').toDataURL(type);
                imgData = imgData.replace(_fixType(type), 'image/octet-stream');

                var save_link = document.createElementNS('http://www.w3.org/1999/xhtml', 'a');
                save_link.href = imgData;
                save_link.download = filename;

                var event = document.createEvent('MouseEvents');
                event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
                save_link.dispatchEvent(event);
            };

            // 下载后的文件名规则

            var filename = (new Date()).getTime() + '.' + type;
        };

        function usernameLogin() {
            $("#loginForm").html(`
			<h3 class="title">登录商城</h3>
                <div class="login-form myform">
                    <form>
                        <div class="user-name">
                            <label for="user"><i class="am-icon-user"></i></label>
                            <input type="text" name="" id="user" placeholder="用户名">
                        </div>
                        <div class="user-pass">
                            <label for="password"><i class="am-icon-lock"></i></label>
                            <input type="password" name="" id="password" placeholder="请输入密码">
                        </div>
                    </form>
                </div>

                <div class="login-links">

                    <a href="#" class="am-fr">忘记密码</a>
                    <a href="register.html" class="zcnext am-fr am-btn-default">注册</a>
                    <br />
                </div>

                <div class="am-cf">
                    <input type="submit" name="" id="loginByUsername" value="登 录" class="am-btn am-btn-primary am-btn-sm">
                </div>
				<span onclick="usernameLogin()" id="s1">账号登录</span>
                <span>|</span>
                <span onclick="phoneLogin()" id="s2">手机登录</span>
                <span>|</span>
                <span onclick="faceLogin()" id="s3">人脸登录</span>
                `);
        }



        function toIndex() {
            window.location.href = 'index.html';
        }

        $("#loginByPhone").click(function() {
            var phone = $("#phone").val();
            var code = $("#code").val();
            if (false) {

            } else {
                $.ajax({
                    type: "post",
                    //后端需要调用的地址
                    url: "127.0.0.1:8080/ShopSystem/loginByPhone",
                    dataType: "json",
                    data: {
                        "phone": phone,
                        "code": code,
                    },
                    // contentType: "json/application",
                    //设置超时
                    timeout: 10000,
                    async: true,
                    success: function(htmlVal) {
                        // console.log(htmlVal);
                        sessionStorage.setItem("user", JSON.stringify(htmlVal));
                        javaex.alert({
                            content: "登录成功",
                            callback: "toIndex()"
                        });

                    },
                    error: function(data) {},
                    //调用执行后调用的函数
                    complete: function(XMLHttpRequest, textStatus) {
                        if (textStatus == 'timeout') {
                            uploadAjax.abort(); //取消请求
                            //超时提示：请求超时，请重试
                            alert("请求超时，请重试");
                        }
                    }
                });
            }
        });
        $("#loginByUsername").click(function() {
            var username = $("#username").val();
            var password = $("#password").val();
            if (false) {

            } else {
                $.ajax({
                    type: "post",
                    //后端需要调用的地址
                    url: "127.0.0.1:8080/ShopSystem/loginByUsername",
                    dataType: "json",
                    data: {
                        "username": username,
                        "password": password,
                    },
                    // contentType: "json/application",
                    //设置超时
                    timeout: 10000,
                    async: true,
                    success: function(htmlVal) {
                        // console.log(htmlVal);
                        sessionStorage.setItem("user", JSON.stringify(htmlVal));
                        javaex.alert({
                            content: "登录成功",
                            callback: "toIndex()"
                        });

                    },
                    error: function(data) {},
                    //调用执行后调用的函数
                    complete: function(XMLHttpRequest, textStatus) {
                        if (textStatus == 'timeout') {
                            uploadAjax.abort(); //取消请求
                            //超时提示：请求超时，请重试
                            alert("请求超时，请重试");
                        }
                    }
                });
            }
        })
    </script>
</head>

<body>

    <div class="login-boxtitle">
        <a href="index.html"><span style="font-size: 40px;">商城</span></a>
    </div>

    <div class="login-banner">
        <div class="login-main">
            <div class="login-banner-bg"><span></span><img src="../images/big.jpg" /></div>
            <!-- 账号密码登录 -->
            <div class="login-box loginDiv" id="loginForm">
                <h3 class="title">登录商城</h3>
                <div class="login-form myform">
                    <form>
                        <div class="user-name">
                            <label for="user"><i class="am-icon-user"></i></label>
                            <input type="text" name="" id="username" placeholder="用户名">
                        </div>
                        <div class="user-pass">
                            <label for="password"><i class="am-icon-lock"></i></label>
                            <input type="password" name="" id="password" placeholder="请输入密码">
                        </div>
                    </form>
                </div>

                <div class="login-links">

                    <a href="#" class="am-fr">忘记密码</a>
                    <a href="register.html" class="zcnext am-fr am-btn-default">注册</a>
                    <br />
                </div>

                <div class="am-cf">
                    <input type="submit" name="" id="loginByUsername" value="登 录" class="am-btn am-btn-primary am-btn-sm">
                </div>
                <span onclick="usernameLogin()" id="s1">账号登录</span>
                <span>|</span>
                <span onclick="phoneLogin()" id="s2">手机登录</span>
                <span>|</span>
                <span onclick="faceLogin()" id="s3">人脸登录</span>

            </div>
        </div>
    </div>


    <div class="footer ">
        <div class="footer-hd ">
            <p>
                <a href="# ">常州信息</a>
                <b>|</b>
                <a href="# ">商城首页</a>

                <b>|</b>
                <a href="# ">物流</a>
            </p>
        </div>
        <div class="footer-bd ">
            <p>
                <em>©常州ccit版权所有</em>
            </p>
        </div>
    </div>

    <canvas style="display: none" id="canvas" width="480" height="320"></canvas>
</body>

</html>