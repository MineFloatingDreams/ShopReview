<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <title>摄像头拍照</title>
</head>

<body>
    <video id="video" width="480" height="320" controls>
</video>
    <div>
        <button id="capture" onclick="uploadImage()">拍照</button>
        <br/>

        <button onClick="saveFile(filename);" type="button">下载图片</button>
    </div>

    <canvas id="canvas" width="480" height="320"></canvas>
    <script>
        //访问用户媒体设备的兼容方法
        function getUserMedia(constraints, success, error) {
            if (navigator.mediaDevices.getUserMedia) {
                //最新的标准API
                navigator.mediaDevices.getUserMedia(constraints).then(success).catch(error);
            } else if (navigator.webkitGetUserMedia) {
                //webkit核心浏览器
                navigator.webkitGetUserMedia(constraints, success, error)
            } else if (navigator.mozGetUserMedia) {
                //firfox浏览器
                navigator.mozGetUserMedia(constraints, success, error);
            } else if (navigator.getUserMedia) {
                //旧版API
                navigator.getUserMedia(constraints, success, error);
            }
        }


        let canvas = document.getElementById('canvas');
        let context = canvas.getContext('2d');

        function success(stream) {
            //兼容webkit核心浏览器
            let CompatibleURL = window.URL || window.webkitURL;
            //将视频流设置为video元素的源
            console.log(stream);

            //video.src = CompatibleURL.createObjectURL(stream);
            video.srcObject = stream;
            video.play();
        }

        function error(error) {
            console.log(`访问用户媒体设备失败${error.name}, ${error.message}`);
        }

        if (navigator.mediaDevices.getUserMedia || navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia) {
            //调用用户媒体设备, 访问摄像头
            getUserMedia({
                video: {
                    width: 480,
                    height: 320
                }
            }, success, error);
        } else {
            alert('不支持访问用户媒体');
        }

        document.getElementById('capture').addEventListener('click', function() {
                context.drawImage(video, 0, 0, 480, 320);
            })
            //图片上传到服务器
            //获取Canvas的编码。
        function uploadImage() {
            canvas.width = 300;
            canvas.height = 300;
            context.drawImage(video, 0, 0, 300, 300);
            var imgData = canvas.toDataURL();
            console.log(imgData);
            //上传到后台。
            var uploadAjax = $.ajax({
                type: "post",
                //后端需要调用的地址
                url: "${pageContext.request.contextPath}/face",
                data: {
                    "imgData": imgData
                },
                contentType: "json/application",
                //设置超时
                timeout: 10000,
                async: true,
                success: function(htmlVal) {
                    alert("登录成功");
                },
                error: function(data) {},
                //调用执行后调用的函数
                complete: function(XMLHttpRequest, textStatus) {
                    if (textStatus == 'timeout') {
                        uploadAjax.abort(); //取消请求
                        //超时提示：请求超时，请重试
                        alert("请求超时，请重试")
                            //请求超时返回首页
                        closeCard();
                    }
                }
            });
        }


        //下面的代码是保存canvas标签里的图片并且将其按一定的规则重命名
        var type = 'png';

        var _fixType = function(type) {
            type = type.toLowerCase().replace(/jpg/i, 'jpeg');
            var r = type.match(/png|jpeg|bmp|gif/)[0];
            return 'image/' + r;
        };

        var saveFile = function(filename) {
            //获取canvas标签里的图片内容
            var imgData = document.getElementById('canvas').toDataURL(type);
            imgData = imgData.replace(_fixType(type), 'image/octet-stream');

            var save_link = document.createElementNS('http://www.w3.org/1999/xhtml', 'a');
            save_link.href = imgData;
            save_link.download = filename;

            var event = document.createEvent('MouseEvents');
            event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            save_link.dispatchEvent(event);
        };

        // 下载后的文件名规则

        var filename = (new Date()).getTime() + '.' + type;
    </script>
</body>

</html>